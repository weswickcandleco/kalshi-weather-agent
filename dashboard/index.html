<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kalshi Weather Agent</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0e14; --surface: #1a1f2e; --surface-light: #242938; --border: #2d3448;
    --text: #e6edf3; --text-muted: #8b949e; --text-dim: #6e7681;
    --primary: #58a6ff; --primary-dark: #388bfd; --primary-light: #79c0ff;
    --green: #3fb950; --green-dark: #238636; --green-light: #56d364;
    --red: #f85149; --red-dark: #da3633; --red-light: #ff7b72;
    --yellow: #d29922; --yellow-dark: #9e6a03; --yellow-light: #e3b341;
    --purple: #a371f7; --purple-dark: #8957e5; --purple-light: #b392f0;
    --shadow: 0 1px 3px rgba(0,0,0,0.5);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.6);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
    line-height: 1.6;
    padding: 0;
    margin: 0;
  }

  /* Header */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(8px);
    box-shadow: var(--shadow);
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  h1 {
    font-size: 24px;
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: var(--surface-light);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Container */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px;
  }

  /* Hero Cards */
  .hero-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .hero-card {
    background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .hero-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .hero-card-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    font-weight: 600;
    margin-bottom: 8px;
  }

  .hero-card-value {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 4px;
    line-height: 1;
  }

  .hero-card-detail {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 8px;
  }

  .trend-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    font-weight: 600;
    margin-left: 8px;
  }

  .trend-up { color: var(--green); }
  .trend-down { color: var(--red); }

  /* Model Explanation */
  .model-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 32px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .model-header {
    padding: 20px 24px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    background: var(--surface-light);
  }

  .model-header:hover {
    background: var(--surface);
  }

  .model-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  .model-subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .expand-icon {
    font-size: 20px;
    color: var(--text-muted);
    transition: transform 0.2s;
  }

  .model-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .model-content.expanded {
    max-height: 2000px;
  }

  .model-content-inner {
    padding: 24px;
  }

  .model-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  .model-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
  }

  .model-card h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 12px;
  }

  .model-card ul {
    list-style: none;
    padding: 0;
  }

  .model-card li {
    padding: 6px 0;
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.5;
  }

  .model-card li::before {
    content: "â–¹";
    color: var(--primary);
    font-weight: bold;
    display: inline-block;
    width: 16px;
  }

  /* Charts Section */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: var(--shadow);
  }

  .chart-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .chart-container {
    position: relative;
    height: 280px;
  }

  .chart-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 280px;
    color: var(--text-dim);
    text-align: center;
  }

  .chart-empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.3;
  }

  .chart-empty-text {
    font-size: 14px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid var(--border);
    margin-bottom: 24px;
  }

  .tab {
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: color 0.2s, border-color 0.2s;
    user-select: none;
  }

  .tab:hover {
    color: var(--text);
  }

  .tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    background: var(--surface);
    border-radius: 8px;
    overflow: hidden;
  }

  th {
    text-align: left;
    padding: 12px 16px;
    background: var(--surface-light);
    color: var(--text-dim);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  tr:last-child td {
    border-bottom: none;
  }

  tr:hover {
    background: var(--surface-light);
  }

  .mono {
    font-family: "SF Mono", "Fira Code", "Consolas", monospace;
    font-size: 12px;
  }

  .right {
    text-align: right;
  }

  /* Badges */
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.3px;
  }

  .badge-win {
    background: rgba(63, 185, 80, 0.15);
    color: var(--green-light);
  }

  .badge-loss {
    background: rgba(248, 81, 73, 0.15);
    color: var(--red-light);
  }

  .badge-pending {
    background: rgba(210, 153, 34, 0.15);
    color: var(--yellow-light);
  }

  .badge-ensemble {
    background: rgba(163, 113, 247, 0.15);
    color: var(--purple-light);
  }

  .badge-sd {
    background: rgba(88, 166, 255, 0.15);
    color: var(--primary-light);
  }

  /* Utilities */
  .green { color: var(--green-light); }
  .red { color: var(--red-light); }
  .yellow { color: var(--yellow-light); }
  .purple { color: var(--purple-light); }
  .blue { color: var(--primary-light); }
  .muted { color: var(--text-muted); }

  .nowrap { white-space: nowrap; }

  .loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 20px;
    }

    .hero-grid {
      grid-template-columns: 1fr;
    }

    .model-grid {
      grid-template-columns: 1fr;
    }

    .charts-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-content">
    <div>
      <h1>Kalshi Weather Agent</h1>
    </div>
    <div class="status-badge">
      <span class="status-dot"></span>
      <span id="status-text">Live</span>
    </div>
  </div>
</div>

<div class="container">
  <!-- Hero Cards -->
  <div class="hero-grid">
    <div class="hero-card">
      <div class="hero-card-label">Total P&L</div>
      <div class="hero-card-value" id="pnl-value">$0.00</div>
      <div class="hero-card-detail" id="pnl-detail">No trades yet</div>
    </div>

    <div class="hero-card">
      <div class="hero-card-label">Win Rate</div>
      <div class="hero-card-value" id="winrate-value">â€”</div>
      <div class="hero-card-detail" id="winrate-detail">0W - 0L - 0 pending</div>
    </div>

    <div class="hero-card">
      <div class="hero-card-label">Active Positions</div>
      <div class="hero-card-value" id="active-value">0</div>
      <div class="hero-card-detail" id="active-detail">Next settlement: 9:00 AM CT</div>
    </div>

    <div class="hero-card">
      <div class="hero-card-label">Return on Investment</div>
      <div class="hero-card-value" id="roi-value">â€”</div>
      <div class="hero-card-detail" id="roi-detail">$0 invested</div>
    </div>
  </div>

  <!-- Model Explanation (Collapsible) -->
  <div class="model-section">
    <div class="model-header" onclick="toggleModel()">
      <div>
        <div class="model-title">How the Bot Works</div>
        <div class="model-subtitle">Ensemble forecasting + split timing strategy</div>
      </div>
      <div class="expand-icon" id="expand-icon">â–¼</div>
    </div>
    <div class="model-content" id="model-content">
      <div class="model-content-inner">
        <!-- SVG Flowchart -->
        <svg width="100%" height="240" style="margin-bottom: 24px;">
          <!-- Models -->
          <rect x="20" y="20" width="140" height="60" rx="8" fill="var(--surface-light)" stroke="var(--border)" stroke-width="2"/>
          <text x="90" y="45" text-anchor="middle" fill="var(--text)" font-size="12" font-weight="600">ECMWF IFS</text>
          <text x="90" y="62" text-anchor="middle" fill="var(--primary)" font-size="16" font-weight="700">51 members</text>

          <rect x="180" y="20" width="140" height="60" rx="8" fill="var(--surface-light)" stroke="var(--border)" stroke-width="2"/>
          <text x="250" y="45" text-anchor="middle" fill="var(--text)" font-size="12" font-weight="600">GFS</text>
          <text x="250" y="62" text-anchor="middle" fill="var(--primary)" font-size="16" font-weight="700">31 members</text>

          <rect x="340" y="20" width="140" height="60" rx="8" fill="var(--surface-light)" stroke="var(--border)" stroke-width="2"/>
          <text x="410" y="45" text-anchor="middle" fill="var(--text)" font-size="12" font-weight="600">ICON</text>
          <text x="410" y="62" text-anchor="middle" fill="var(--primary)" font-size="16" font-weight="700">40 members</text>

          <!-- Arrow down -->
          <line x1="250" y1="85" x2="250" y2="105" stroke="var(--border)" stroke-width="3" marker-end="url(#arrowhead)"/>
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="var(--border)"/>
            </marker>
          </defs>

          <!-- Ensemble -->
          <rect x="150" y="110" width="200" height="50" rx="8" fill="var(--purple-dark)" stroke="var(--purple)" stroke-width="2" opacity="0.3"/>
          <text x="250" y="140" text-anchor="middle" fill="var(--purple-light)" font-size="18" font-weight="700">122 Forecasts</text>

          <!-- Arrow down -->
          <line x1="250" y1="165" x2="250" y2="185" stroke="var(--border)" stroke-width="3" marker-end="url(#arrowhead)"/>

          <!-- P(YES) -->
          <rect x="170" y="190" width="160" height="40" rx="8" fill="var(--green-dark)" stroke="var(--green)" stroke-width="2" opacity="0.3"/>
          <text x="250" y="215" text-anchor="middle" fill="var(--green-light)" font-size="14" font-weight="700">P(YES) Calculation</text>
        </svg>

        <!-- Details Grid -->
        <div class="model-grid">
          <div class="model-card">
            <h3>Ensemble Model</h3>
            <ul>
              <li>122 independent weather forecasts from 3 global models</li>
              <li>Empirical probability distribution (not just one forecast)</li>
              <li>Accounts for model uncertainty and forecast spread</li>
              <li>Fallback to calibrated standard deviation if ensemble unavailable</li>
            </ul>
          </div>

          <div class="model-card">
            <h3>Split Timing Strategy</h3>
            <ul>
              <li><strong>8:00 PM CT:</strong> Bet on LOW temps for tomorrow (9hrs before overnight low)</li>
              <li><strong>9:30 AM CT:</strong> Bet on HIGH temps for today (2-4hrs before afternoon peak)</li>
              <li>Reduces exposure time and captures freshest forecasts</li>
              <li>$4 budget per run ($8/day total)</li>
            </ul>
          </div>

          <div class="model-card">
            <h3>Probability Math</h3>
            <ul>
              <li>Normal distribution centered on NWS forecast</li>
              <li>Forecast error SDs calibrated by city and season</li>
              <li>Example: Chicago winter = 7Â°F SD, summer = 4Â°F SD</li>
              <li>Ensemble overrides SD model when 10+ members available</li>
            </ul>
          </div>

          <div class="model-card">
            <h3>Risk Guardrails</h3>
            <ul>
              <li><strong>EV threshold:</strong> Only bet when expected value > +5Â¢</li>
              <li><strong>Price range:</strong> 15-85Â¢ (avoid extreme odds)</li>
              <li><strong>City limits:</strong> Max 2 bets per city per day</li>
              <li><strong>Dedup:</strong> Never bet opposite sides or duplicate tickers</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">P&L Over Time</div>
      <div class="chart-container">
        <canvas id="pnl-chart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">Win Rate Trend</div>
      <div class="chart-container">
        <canvas id="winrate-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="trades" onclick="switchTab('trades')">All Trades</div>
    <div class="tab" data-tab="runs" onclick="switchTab('runs')">Run History</div>
    <div class="tab" data-tab="calibration" onclick="switchTab('calibration')">Calibration</div>
  </div>

  <!-- Tab: All Trades -->
  <div class="tab-content active" id="tab-trades">
    <table id="trades-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>City</th>
          <th>Ticker</th>
          <th>Side</th>
          <th class="right">Cost</th>
          <th class="right">Prob</th>
          <th>Source</th>
          <th class="right">EV</th>
          <th>Result</th>
          <th class="right">P&L</th>
        </tr>
      </thead>
      <tbody id="trades-body"></tbody>
    </table>
  </div>

  <!-- Tab: Run History -->
  <div class="tab-content" id="tab-runs">
    <table id="runs-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Mode</th>
          <th>Target Date</th>
          <th>Cities</th>
          <th class="right">Placed</th>
          <th class="right">Skipped</th>
          <th class="right">Cost</th>
        </tr>
      </thead>
      <tbody id="runs-body"></tbody>
    </table>
  </div>

  <!-- Tab: Calibration -->
  <div class="tab-content" id="tab-calibration">
    <table id="calibration-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>City</th>
          <th>Type</th>
          <th class="right">Forecast</th>
          <th class="right">Observed</th>
          <th class="right">Error</th>
          <th>Ensemble</th>
        </tr>
      </thead>
      <tbody id="calibration-body"></tbody>
    </table>
  </div>
</div>

<script>
const DATA_URL = 'data.json';
let tradeData = null;
let pnlChart = null;
let winrateChart = null;

// Toggle model explanation
function toggleModel() {
  const content = document.getElementById('model-content');
  const icon = document.getElementById('expand-icon');
  content.classList.toggle('expanded');
  icon.textContent = content.classList.contains('expanded') ? 'â–²' : 'â–¼';
}

// Switch tabs
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// Load data
async function loadData() {
  try {
    const resp = await fetch(DATA_URL + '?t=' + Date.now());
    tradeData = await resp.json();

    renderHeroCards(tradeData);
    renderCharts(tradeData);
    renderTrades(tradeData.trades);
    renderRuns(tradeData.runs);
    renderCalibration(tradeData.trades);

    document.getElementById('status-text').textContent = 'Live Â· Updated ' + formatTime(tradeData.exported_at);
  } catch (e) {
    document.getElementById('status-text').textContent = 'Error loading data';
    console.error('Failed to load data:', e);
  }
}

// Hero cards
function renderHeroCards(data) {
  const pnl = data.pnl;
  const net = pnl.net_pnl_dollars || 0;
  const invested = pnl.total_cost_dollars || 0;
  const wins = pnl.wins || 0;
  const losses = pnl.losses || 0;
  const pending = pnl.pending || 0;
  const winRate = pnl.win_rate;
  const roi = invested > 0 ? (net / invested) * 100 : 0;

  // P&L
  const pnlClass = net >= 0 ? 'green' : 'red';
  const pnlSign = net >= 0 ? '+' : '';
  document.getElementById('pnl-value').textContent = pnlSign + '$' + net.toFixed(2);
  document.getElementById('pnl-value').className = 'hero-card-value ' + pnlClass;
  document.getElementById('pnl-detail').textContent = invested > 0 ? `$${invested.toFixed(2)} invested` : 'No trades yet';

  // Win Rate
  const wrDisplay = winRate !== null ? (winRate * 100).toFixed(0) + '%' : 'â€”';
  document.getElementById('winrate-value').textContent = wrDisplay;
  document.getElementById('winrate-detail').textContent = `${wins}W - ${losses}L - ${pending} pending`;

  // Active
  document.getElementById('active-value').textContent = pending;

  // ROI
  const roiDisplay = invested > 0 ? (roi >= 0 ? '+' : '') + roi.toFixed(1) + '%' : 'â€”';
  const roiClass = roi >= 0 ? 'green' : 'red';
  document.getElementById('roi-value').textContent = roiDisplay;
  document.getElementById('roi-value').className = 'hero-card-value ' + roiClass;
  document.getElementById('roi-detail').textContent = invested > 0 ? `$${invested.toFixed(2)} invested` : '$0 invested';
}

// Charts
function renderCharts(data) {
  renderPnLChart(data);
  renderWinRateChart(data);
}

function renderPnLChart(data) {
  const ctx = document.getElementById('pnl-chart');

  if (data.trades.length === 0) {
    ctx.style.display = 'none';
    ctx.parentElement.innerHTML = '<div class="chart-empty"><div class="chart-empty-icon">ðŸ“Š</div><div class="chart-empty-text">No P&L data yet<br>First bets tonight at 8 PM CT</div></div>';
    return;
  }

  // Group by date, calculate cumulative P&L
  const byDate = {};
  for (const t of data.trades) {
    if (t.dry_run || !t.filled) continue;
    const d = t.target_date;
    if (!byDate[d]) byDate[d] = { pnl: 0 };
    if (t.settlement_result === 'win') {
      byDate[d].pnl += (t.payout_cents - t.cost_cents) / 100;
    } else if (t.settlement_result === 'loss') {
      byDate[d].pnl -= t.cost_cents / 100;
    }
  }

  const dates = Object.keys(byDate).sort();
  let cumulative = 0;
  const cumulativeData = dates.map(d => {
    cumulative += byDate[d].pnl;
    return cumulative;
  });

  if (pnlChart) pnlChart.destroy();
  pnlChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Cumulative P&L',
        data: cumulativeData,
        borderColor: cumulativeData[cumulativeData.length - 1] >= 0 ? '#3fb950' : '#f85149',
        backgroundColor: cumulativeData[cumulativeData.length - 1] >= 0 ? 'rgba(63, 185, 80, 0.1)' : 'rgba(248, 81, 73, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => '$' + ctx.parsed.y.toFixed(2)
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#8b949e', callback: v => '$' + v }
        },
        x: {
          ticks: { color: '#8b949e' }
        }
      }
    }
  });
}

function renderWinRateChart(data) {
  const ctx = document.getElementById('winrate-chart');

  if (data.trades.length === 0) {
    ctx.style.display = 'none';
    ctx.parentElement.innerHTML = '<div class="chart-empty"><div class="chart-empty-icon">ðŸ“ˆ</div><div class="chart-empty-text">No win rate data yet<br>First settlements tomorrow at 9 AM CT</div></div>';
    return;
  }

  // Group by date, calculate win rate
  const byDate = {};
  for (const t of data.trades) {
    if (t.dry_run || !t.filled || !t.settlement_result || t.settlement_result === 'pending') continue;
    const d = t.target_date;
    if (!byDate[d]) byDate[d] = { wins: 0, total: 0 };
    byDate[d].total++;
    if (t.settlement_result === 'win') byDate[d].wins++;
  }

  const dates = Object.keys(byDate).sort();
  const winRates = dates.map(d => (byDate[d].wins / byDate[d].total) * 100);

  if (winrateChart) winrateChart.destroy();
  winrateChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Win Rate',
        data: winRates,
        borderColor: '#58a6ff',
        backgroundColor: 'rgba(88, 166, 255, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ctx.parsed.y.toFixed(0) + '%'
          }
        }
      },
      scales: {
        y: {
          min: 0,
          max: 100,
          ticks: { color: '#8b949e', callback: v => v + '%' }
        },
        x: {
          ticks: { color: '#8b949e' }
        }
      }
    }
  });
}

// Trades table
function renderTrades(trades) {
  if (trades.length === 0) {
    document.getElementById('trades-body').innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No trades yet â€” first run tonight at 8 PM CT</td></tr>';
    return;
  }

  const sorted = [...trades].sort((a, b) => b.timestamp.localeCompare(a.timestamp));
  let html = '';

  for (const t of sorted) {
    if (t.dry_run) continue; // Hide dry runs

    const cost = (t.cost_cents / 100).toFixed(2);
    const prob = t.est_probability !== null ? (t.est_probability * 100).toFixed(0) + '%' : 'â€”';
    const ev = t.expected_value_cents !== null ? '+' + t.expected_value_cents.toFixed(0) + 'c' : 'â€”';

    const srcBadge = t.prob_source === 'ensemble' ? '<span class="badge badge-ensemble">Ensemble</span>' : '<span class="badge badge-sd">SD Model</span>';

    let resultBadge, pnl;
    if (!t.filled) {
      resultBadge = '<span class="badge" style="background:rgba(107,114,128,0.15);color:#9ca3af">Unfilled</span>';
      pnl = 'â€”';
    } else if (t.settlement_result === 'win') {
      resultBadge = '<span class="badge badge-win">WIN</span>';
      const profit = (t.payout_cents - t.cost_cents) / 100;
      pnl = '<span class="green">+$' + profit.toFixed(2) + '</span>';
    } else if (t.settlement_result === 'loss') {
      resultBadge = '<span class="badge badge-loss">LOSS</span>';
      pnl = '<span class="red">-$' + cost + '</span>';
    } else {
      resultBadge = '<span class="badge badge-pending">Pending</span>';
      pnl = '<span class="yellow">?</span>';
    }

    html += `<tr>
      <td class="nowrap">${t.target_date}</td>
      <td><strong>${t.city}</strong></td>
      <td class="mono">${t.ticker}</td>
      <td>${t.side.toUpperCase()}</td>
      <td class="right nowrap">$${cost}</td>
      <td class="right">${prob}</td>
      <td>${srcBadge}</td>
      <td class="right">${ev}</td>
      <td>${resultBadge}</td>
      <td class="right nowrap">${pnl}</td>
    </tr>`;
  }

  document.getElementById('trades-body').innerHTML = html || '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No live trades yet</td></tr>';
}

// Runs table
function renderRuns(runs) {
  if (runs.length === 0) {
    document.getElementById('runs-body').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No runs yet</td></tr>';
    return;
  }

  let html = '';
  for (const r of runs) {
    html += `<tr>
      <td class="nowrap">${formatTime(r.timestamp)}</td>
      <td>${r.mode}</td>
      <td>${r.target_date}</td>
      <td>${r.cities}</td>
      <td class="right">${r.trades_placed}</td>
      <td class="right">${r.trades_skipped}</td>
      <td class="right">$${(r.total_cost_cents / 100).toFixed(2)}</td>
    </tr>`;
  }

  document.getElementById('runs-body').innerHTML = html;
}

// Calibration table
function renderCalibration(trades) {
  const settled = trades.filter(t => t.filled && !t.dry_run && t.observed_high_f !== null && (t.settlement_result === 'win' || t.settlement_result === 'loss'));

  if (settled.length === 0) {
    document.getElementById('calibration-body').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No settled trades with observed temps yet</td></tr>';
    return;
  }

  const seen = new Set();
  let html = '';

  for (const t of settled) {
    const key = t.target_date + '-' + t.city;
    if (seen.has(key)) continue;
    seen.add(key);

    // High
    const fH = t.forecast_high_f;
    const oH = t.observed_high_f !== null ? Math.round(t.observed_high_f) : null;
    const errH = (fH !== null && oH !== null) ? oH - fH : null;
    const errHClass = errH !== null ? (Math.abs(errH) > 5 ? 'red' : Math.abs(errH) > 3 ? 'yellow' : 'green') : '';
    const ensH = t.ensemble_mean_high !== null ? `${t.ensemble_mean_high}F Â±${t.ensemble_sd_high || '?'}` : 'â€”';

    html += `<tr>
      <td>${t.target_date}</td>
      <td><strong>${t.city}</strong></td>
      <td>High</td>
      <td class="right">${fH !== null ? fH + 'F' : 'â€”'}</td>
      <td class="right">${oH !== null ? oH + 'F' : 'â€”'}</td>
      <td class="right ${errHClass}">${errH !== null ? errH + 'F' : 'â€”'}</td>
      <td>${ensH}</td>
    </tr>`;

    // Low
    const fL = t.forecast_low_f;
    const oL = t.observed_low_f !== null ? Math.round(t.observed_low_f) : null;
    const errL = (fL !== null && oL !== null) ? oL - fL : null;
    const errLClass = errL !== null ? (Math.abs(errL) > 5 ? 'red' : Math.abs(errL) > 3 ? 'yellow' : 'green') : '';
    const ensL = t.ensemble_mean_low !== null ? `${t.ensemble_mean_low}F Â±${t.ensemble_sd_low || '?'}` : 'â€”';

    html += `<tr>
      <td>${t.target_date}</td>
      <td><strong>${t.city}</strong></td>
      <td>Low</td>
      <td class="right">${fL !== null ? fL + 'F' : 'â€”'}</td>
      <td class="right">${oL !== null ? oL + 'F' : 'â€”'}</td>
      <td class="right ${errLClass}">${errL !== null ? errL + 'F' : 'â€”'}</td>
      <td>${ensL}</td>
    </tr>`;
  }

  document.getElementById('calibration-body').innerHTML = html;
}

// Format time
function formatTime(iso) {
  if (!iso) return 'â€”';
  try {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString('en-US', {
      timeZone: 'America/Chicago',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    }) + ' CT';
  } catch (e) {
    return iso;
  }
}

// Init
loadData();
</script>

</body>
</html>
